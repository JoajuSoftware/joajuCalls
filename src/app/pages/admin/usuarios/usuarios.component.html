@if (isLoading) {
    <div class="spinner-container">
        <p-progressSpinner
            styleClass="custom-spinner"
            strokeWidth="8"
            fill="var(--surface-ground)"
            animationDuration=".5s">
        </p-progressSpinner>
    </div>
} @else {
    <div class="card">
        <p-toast />
        <p-toolbar styleClass="mb-4 gap-2">
            <ng-template pTemplate="left">
                <p-button
                    severity="success" 
                    label="Nuevo"
                    icon="pi pi-plus" 
                    class="mr-2" 
                    (onClick)="openNew()" />
            </ng-template>
        </p-toolbar>

        <p-table
            #dt
            [value]="usuarios"
            [rows]="10"
            [paginator]="true"
            [globalFilterFields]="['n_usuario']"
            [tableStyle]="{ 'min-width': '75rem' }"
            [(selection)]="selectedUsuarios"
            [rowHover]="true"
            dataKey="id_usuario"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
            [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <h5 class="m-0">Gestionar Usuarios</h5>
                  <span class="p-input-icon-left">
                    <input 
                        pInputText 
                        type="text"
                        (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                        placeholder="Buscar por usuario..." />
                    </span>
                </div>
            </ng-template>              
            <ng-template pTemplate="header">
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Nombre</th>
                    <th>Extensión</th>
                    <th>Perfil</th>
                    <th>Team</th>
                    <th>Estado</th>
                    <th></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-usuario>
                <tr>
                    <td>{{usuario.id_usuario}}</td>
                    <td>{{usuario.n_usuario}}</td>
                    <td>{{usuario.nom}} {{usuario.ape}}</td>
                    <td>{{usuario.nro_exten}}</td>
                    <td>{{usuario.n_perfil}}</td>
                    <td>{{usuario.team}}</td>
                    <td>{{usuario.activo === '1' ? 'Activo' : 'Inactivo'}}</td>
                    <td>
                        <p-button 
                            icon="pi pi-pencil" 
                            class="mr-2" 
                            [rounded]="true" 
                            [outlined]="true" 
                            severity="success"
                            (onClick)="editUsuario(usuario)" />
                        <p-button 
                            icon="pi pi-trash" 
                            [rounded]="true" 
                            [outlined]="true" 
                            severity="danger"  />
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <p-dialog 
            [(visible)]="usuarioDialog" 
            [style]="{ width: '600px' }" 
            draggable="false"
            header="Crear Usuario" 
            [modal]="true" 
            styleClass="p-fluid">
            <form [formGroup]="usuarioForm" (ngSubmit)="saveUsuario()" class="grid">
        
                <div class="col-12 mb-3">
                    <label for="usuario" class="block text-base font-medium mb-2">Usuario</label>
                    <input 
                        type="text" 
                        pInputText 
                        id="usuario" 
                        formControlName="usuario" 
                        class="w-full p-inputtext"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && usuarioFormControls['usuario'].invalid}"
                        placeholder="Ingrese el nombre de usuario" />
                    @if(submitted && usuarioFormControls['usuario'].invalid){
                        <small class="p-error block mt-1">Este campo es requerido</small>
                    }
                </div>
        
                <div class="col-12 mb-3">
                    <label for="nombre" class="block text-base font-medium mb-2">Nombre</label>
                    <input 
                        type="text" 
                        pInputText 
                        id="nombre" 
                        formControlName="nombre" 
                        class="w-full p-inputtext"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && usuarioFormControls['nombre'].invalid}"
                        placeholder="Ingrese el nombre" />
                    @if(submitted && usuarioFormControls['nombre'].invalid){
                        <small class="p-error block mt-1">Este campo es requerido</small>
                    }
                </div>
        
                <div class="col-12 mb-3">
                    <label for="apellido" class="block text-base font-medium mb-2">Apellido</label>
                    <input 
                        type="text" 
                        pInputText 
                        id="apellido" 
                        formControlName="apellido" 
                        class="w-full p-inputtext"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && usuarioFormControls['apellido'].invalid}"
                        placeholder="Ingrese el apellido" />
                    @if(submitted && usuarioFormControls['apellido'].invalid){
                        <small class="p-error block mt-1">Este campo es requerido</small>
                    }
                </div>
        
                <div class="col-12 mb-3">
                    <label for="crea_pass" class="block text-base font-medium mb-2">Contraseña</label>
                    <input 
                        type="password" 
                        pInputText 
                        id="crea_pass" 
                        formControlName="crea_pass" 
                        class="w-full p-inputtext"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && usuarioFormControls['crea_pass'].invalid}"
                        placeholder="Ingrese la contraseña" />
                    @if(submitted && usuarioFormControls['crea_pass'].invalid){
                        <small class="p-error block mt-1">La contraseña debe tener al menos 6 caracteres</small>
                    }
                </div>
        
                <div class="col-12 mb-3">
                    <label for="crea_pass2" class="block text-base font-medium mb-2">Confirmar Contraseña</label>
                    <input 
                        type="password" 
                        pInputText 
                        id="crea_pass2" 
                        formControlName="crea_pass2" 
                        class="w-full p-inputtext"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && usuarioFormControls['crea_pass2'].invalid || usuarioForm.hasError('mismatch')}"
                        placeholder="Confirme la contraseña" />
                    @if(submitted && (usuarioFormControls['crea_pass2'].invalid || usuarioForm.hasError('mismatch'))){
                        <small class="p-error block mt-1">Las contraseñas no coinciden</small>
                    }
                </div>
        
                <div class="col-12 mb-3">
                    <label for="acd_predef" class="block text-base font-medium mb-2">ACD Predefinido</label>
                    <input 
                        type="text" 
                        pInputText 
                        id="acd_predef" 
                        formControlName="acd_predef" 
                        class="w-full p-inputtext"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && usuarioFormControls['acd_predef'].invalid}"
                        placeholder="ACD por defecto 4001" />
                    @if(submitted && usuarioFormControls['acd_predef'].invalid){
                        <small class="p-error block mt-1">Este campo es requerido</small>
                    }
                </div>
        
                <div class="col-12 flex justify-content-end gap-2 mt-4">
                    <p-button 
                    label="Guardar" 
                    icon="pi pi-check" 
                    type="submit"
                    [loading]="isSubmitting">
                </p-button>
                <p-button 
                    label="Cancelar" 
                    icon="pi pi-times" 
                    (onClick)="hideDialog()" 
                    styleClass="p-button-text">
                </p-button>
                </div>
            </form>
        </p-dialog>

        <p-confirmDialog [style]="{ width: '450px' }" />
    </div>
}
